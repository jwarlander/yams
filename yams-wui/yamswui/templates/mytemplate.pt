<!DOCTYPE html>
<html>
  <head>
    <title>Yet Another Monitoring System</title>
    <script src="/static/jquery-2.0.0.min.js"></script>
    <script src="/static/flotr2.min.js"></script>
    <style type="text/css">
      body {
        margin: 0px;
        padding: 0px;
      }
      #container {
        width : 600px;
        height: 384px;
        margin: 8px auto;
      }
    </style>
  </head>
  <body>
    <div id="plugins" style="float: left; height: 100%; width: 100px">...</div>

    <script type="text/javascript">
      $( document ).ready( function() {
        function list_plugins( content ) {
          $( '#plugins' ).html( content );
        }
        $.get( "plugins", list_plugins );
      });
    </script>

    <div id="container"></div>

    <script type="text/javascript">
      ( function () {
        var ajax_calls = [],
            data = [];

        function myDateFormatter( ctime ) {
          myDate = new Date();
          myDate.setTime( ctime );
          return myDate.toLocaleString();
        }

        function process_csv(csv) {
          var tmp_data = [],
              lines = csv.split( "\n" ),
              headers = lines[ 0 ].split( "," ),
              rows = lines.length - 1, // Don't count the line with the header.
              cols = headers.length,
              col, row;

          // Break down the header to set labels for the legend.
          for ( col = 1; col < cols; col++ ) {
			tmp_data.push( { 'data': [], 'label': headers[ col ] } );
          }

          // Transform the data to plot.
          for ( row = 1; row < rows; row++ ) {
            line = lines[ row ].split( "," );
            for ( col = 1; col < cols; col++ ) {
              tmp_data[ col - 1 ][ 'data' ].push( [ line[ 0 ], line[ col ] ] );
            }
          }

          for ( col = 0; col < cols - 1; col++ ) {
            data.push( tmp_data[ col ] );
          }
        }

        <?python
          jscode = ' '.join('ajax_calls.push( $.get( "%s", process_csv ) );' % url for url in url_list)
        ?>
        ${jscode}

        $.when.apply( this, ajax_calls ).done( function() {
          var container = document.getElementById( 'container' ),
              graph;

          // Draw Graph
          graph = Flotr.draw( container, data, {
            legend: {
              position: 'nw',
            },
            xaxis : {
              tickFormatter: myDateFormatter
            },
            yaxis : {
              min: 0
            }
          } );
        } );
      } )();
    </script>
  </body>
</html>
